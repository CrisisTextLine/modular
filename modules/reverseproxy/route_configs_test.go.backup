package reverseproxy

import (
	"log/slog"
	"net/http"
	"net/http/httptest"
	"os"
	"testing"

	"github.com/CrisisTextLine/modular"
)

func TestBasicRouteConfigsFeatureFlagRouting(t *testing.T) {
	// Create mock backends
	primaryBackend := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		_, _ = w.Write([]byte("primary-backend-response"))
	}))
	defer primaryBackend.Close()

	alternativeBackend := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		_, _ = w.Write([]byte("alternative-backend-response"))
	}))
	defer alternativeBackend.Close()

	// Create mock router
	mockRouter := &testRouter{routes: make(map[string]http.HandlerFunc)}

	// Create feature flag evaluator
	app := NewMockTenantApplication()
	logger := slog.New(slog.NewTextHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelDebug}))
	
	// Register configuration for the feature flag evaluator first
	baseConfig := &ReverseProxyConfig{
		FeatureFlags: FeatureFlagsConfig{
			Enabled: true,
			Flags: map[string]bool{
				"avatar-api": false, // Will be overridden in individual tests
			},
		},
	}
	app.RegisterConfigSection("reverseproxy", NewStdConfigProvider(baseConfig))
	
	// Register tenant service for proper configuration management
	tenantService := modular.NewStandardTenantService(logger)
	app.RegisterService("tenantService", tenantService)
	
	featureFlagEvaluator := NewFileBasedFeatureFlagEvaluator(app, logger)

	// Create reverse proxy module
	module := NewModule()

	// Register config first (this sets the app reference)
	if err := module.RegisterConfig(app); err != nil {
		t.Fatalf("Failed to register config: %v", err)
	}

	// Configure the module
	config := &ReverseProxyConfig{
		BackendServices: map[string]string{
			"chimera": primaryBackend.URL,
			"default": alternativeBackend.URL,
		},
		Routes: map[string]string{
			"/api/v1/avatar/*": "chimera",
		},
		RouteConfigs: map[string]RouteConfig{
			"/api/v1/avatar/*": {
				FeatureFlagID:      "avatar-api",
				AlternativeBackend: "default",
			},
		},
		DefaultBackend:  "default",
		TenantIDHeader:  "X-Affiliate-Id",
		RequireTenantID: false,
	}

	// Replace config with our configured one
	app.RegisterConfigSection("reverseproxy", NewStdConfigProvider(config))

	// Initialize with services
	services := map[string]any{
		"router":               mockRouter,
		"featureFlagEvaluator": featureFlagEvaluator,
	}

	constructedModule, err := module.Constructor()(app, services)
	if err != nil {
		t.Fatalf("Failed to construct module: %v", err)
	}

	reverseProxyModule := constructedModule.(*ReverseProxyModule)

	// Initialize the module
	if err := reverseProxyModule.Init(app); err != nil {
		t.Fatalf("Failed to initialize module: %v", err)
	}

	// Set up configuration with feature flag disabled
	config = &ReverseProxyConfig{
		FeatureFlags: FeatureFlagsConfig{
			Enabled: true,
			Flags: map[string]bool{
				"avatar-api": false, // Feature flag disabled
			},
		},
		BackendServices: map[string]string{
			"primary":     primaryBackend.URL,
			"alternative": alternativeBackend.URL,
		},
		RouteConfigs: map[string]RouteConfig{
			"/api/v1/avatar/*": {
				FeatureFlagID:      "avatar-api",
				AlternativeBackend: "alternative",
			},
		},
		DefaultBackend: "primary",
	}
	app.RegisterConfigSection("reverseproxy", modular.NewStdConfigProvider(config))

	// Start the module
	if err := reverseProxyModule.Start(app.Context()); err != nil {
		t.Fatalf("Failed to start module: %v", err)
	}

	// Feature flag is disabled, should route to alternative backend
	handler := mockRouter.routes["/api/v1/avatar/*"]
	if handler == nil {
		t.Fatal("Handler not registered for /api/v1/avatar/*")
	}

	req := httptest.NewRequest("POST", "/api/v1/avatar/upload", nil)
	recorder := httptest.NewRecorder()

	handler(recorder, req)

	if recorder.Code != http.StatusOK {
		t.Errorf("Expected status 200, got %d", recorder.Code)
	}

	body := recorder.Body.String()
	if body != "alternative-backend-response" {
		t.Errorf("Expected 'alternative-backend-response', got '%s'", body)
	}

	t.Run("FeatureFlagEnabled_UsesPrimaryBackend", func(t *testing.T) {
		// Enable feature flag by updating the configuration
		enabledConfig := &ReverseProxyConfig{
			FeatureFlags: FeatureFlagsConfig{
				Enabled: true,
				Flags: map[string]bool{
					"avatar-api": true, // Enable the flag
				},
			},
		}
		app.RegisterConfigSection("reverseproxy", NewStdConfigProvider(enabledConfig))
		
		// Create a new evaluator with the updated configuration
		newEvaluator := NewFileBasedFeatureFlagEvaluator(app, logger)
		
		// Replace the feature flag evaluator in the module
		services := map[string]any{
			"router":               mockRouter,
			"featureFlagEvaluator": newEvaluator,
		}
		
		// Reinitialize the module with new evaluator
		newModule := NewModule()
		if err := newModule.RegisterConfig(app); err != nil {
			t.Fatalf("Failed to register config: %v", err)
		}
		
		constructedModule, err := newModule.Constructor()(app, services)
		if err != nil {
			t.Fatalf("Failed to construct module: %v", err)
		}
		
		newReverseProxyModule := constructedModule.(*ReverseProxyModule)
		
		if err := newReverseProxyModule.Init(app); err != nil {
			t.Fatalf("Failed to initialize module: %v", err)
		}
		
		// Update configuration to enable flag for route behavior
		config := &ReverseProxyConfig{
			FeatureFlags: FeatureFlagsConfig{
				Enabled: true,
				Flags: map[string]bool{
					"avatar-api": true, // Enable flag for primary backend
				},
			},
			BackendServices: map[string]string{
				"chimera": primaryBackend.URL,
				"default": alternativeBackend.URL,
			},
			Routes: map[string]string{
				"/api/v1/avatar/*": "chimera",
			},
			RouteConfigs: map[string]RouteConfig{
				"/api/v1/avatar/*": {
					FeatureFlagID:      "avatar-api",
					AlternativeBackend: "default",
				},
			},
			DefaultBackend:  "default",
			TenantIDHeader:  "X-Affiliate-Id",
			RequireTenantID: false,
		}
		app.RegisterConfigSection("reverseproxy", NewStdConfigProvider(config))
		
		if err := newReverseProxyModule.Start(app.Context()); err != nil {
			t.Fatalf("Failed to start module: %v", err)
		}

		// Feature flag is enabled, should route to primary backend
		handler := mockRouter.routes["/api/v1/avatar/*"]
		if handler == nil {
			t.Fatal("Handler not registered for /api/v1/avatar/*")
		}

		req := httptest.NewRequest("POST", "/api/v1/avatar/upload", nil)
		recorder := httptest.NewRecorder()

		handler(recorder, req)

		if recorder.Code != http.StatusOK {
			t.Errorf("Expected status 200, got %d", recorder.Code)
		}

		body := recorder.Body.String()
		if body != "primary-backend-response" {
			t.Errorf("Expected 'primary-backend-response', got '%s'", body)
		}
	})
}

func TestRouteConfigsWithTenantSpecificFlags(t *testing.T) {
	// Create mock backends
	primaryBackend := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		_, _ = w.Write([]byte("primary-backend-response"))
	}))
	defer primaryBackend.Close()

	alternativeBackend := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		_, _ = w.Write([]byte("alternative-backend-response"))
	}))
	defer alternativeBackend.Close()

	// Create mock router
	mockRouter := &testRouter{routes: make(map[string]http.HandlerFunc)}

	// Create feature flag evaluator with tenant-specific flags
	app := NewMockTenantApplication()
	logger := slog.New(slog.NewTextHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelDebug}))
	
	// Register tenant service
	tenantService := modular.NewStandardTenantService(logger)
	app.RegisterService("tenantService", tenantService)
	
	// Register global configuration with default flags
	globalConfig := &ReverseProxyConfig{
		FeatureFlags: FeatureFlagsConfig{
			Enabled: true,
			Flags: map[string]bool{
				"avatar-api": true, // Global default is true
			},
		},
	}
	app.RegisterConfigSection("reverseproxy", NewStdConfigProvider(globalConfig))
	
	// Register tenant "ctl" with overridden flag
	tenantConfig := &ReverseProxyConfig{
		FeatureFlags: FeatureFlagsConfig{
			Enabled: true,
			Flags: map[string]bool{
				"avatar-api": false, // Tenant-specific override to false
			},
		},
	}
	tenantService.RegisterTenant("ctl", map[string]modular.ConfigProvider{
		"reverseproxy": NewStdConfigProvider(tenantConfig),
	})
	
	featureFlagEvaluator := NewFileBasedFeatureFlagEvaluator(app, logger)

	// Create mock application (needs to be TenantApplication) - already created above

	// Create reverse proxy module and register config
	module := NewModule()
	if err := module.RegisterConfig(app); err != nil {
		t.Fatalf("Failed to register config: %v", err)
	}

	// Configure the module
	config := &ReverseProxyConfig{
		BackendServices: map[string]string{
			"chimera": primaryBackend.URL,
			"default": alternativeBackend.URL,
		},
		Routes: map[string]string{
			"/api/v1/avatar/*": "chimera",
		},
		RouteConfigs: map[string]RouteConfig{
			"/api/v1/avatar/*": {
				FeatureFlagID:      "avatar-api",
				AlternativeBackend: "default",
			},
		},
		DefaultBackend:  "default",
		TenantIDHeader:  "X-Affiliate-Id",
		RequireTenantID: false,
	}

	// Replace config with our configured one
	app.RegisterConfigSection("reverseproxy", NewStdConfigProvider(config))

	// Initialize with services
	services := map[string]any{
		"router":               mockRouter,
		"featureFlagEvaluator": featureFlagEvaluator,
	}

	constructedModule, err := module.Constructor()(app, services)
	if err != nil {
		t.Fatalf("Failed to construct module: %v", err)
	}

	reverseProxyModule := constructedModule.(*ReverseProxyModule)

	// Initialize the module
	if err := reverseProxyModule.Init(app); err != nil {
		t.Fatalf("Failed to initialize module: %v", err)
	}

	// Start the module
	if err := reverseProxyModule.Start(app.Context()); err != nil {
		t.Fatalf("Failed to start module: %v", err)
	}

	t.Run("RequestWithoutTenantID_UsesGlobalFlag", func(t *testing.T) {
		// No tenant ID, should use global flag (true) -> primary backend
		handler := mockRouter.routes["/api/v1/avatar/*"]
		if handler == nil {
			t.Fatal("Handler not registered for /api/v1/avatar/*")
		}

		req := httptest.NewRequest("POST", "/api/v1/avatar/upload", nil)
		recorder := httptest.NewRecorder()

		handler(recorder, req)

		if recorder.Code != http.StatusOK {
			t.Errorf("Expected status 200, got %d", recorder.Code)
		}

		body := recorder.Body.String()
		if body != "primary-backend-response" {
			t.Errorf("Expected 'primary-backend-response', got '%s'", body)
		}
	})

	t.Run("RequestWithTenantID_UsesTenantSpecificFlag", func(t *testing.T) {
		// Tenant ID "ctl" has flag set to false -> alternative backend
		handler := mockRouter.routes["/api/v1/avatar/*"]
		if handler == nil {
			t.Fatal("Handler not registered for /api/v1/avatar/*")
		}

		req := httptest.NewRequest("POST", "/api/v1/avatar/upload", nil)
		req.Header.Set("X-Affiliate-Id", "ctl")
		recorder := httptest.NewRecorder()

		handler(recorder, req)

		if recorder.Code != http.StatusOK {
			t.Errorf("Expected status 200, got %d", recorder.Code)
		}

		body := recorder.Body.String()
		if body != "alternative-backend-response" {
			t.Errorf("Expected 'alternative-backend-response', got '%s'", body)
		}
	})
}
